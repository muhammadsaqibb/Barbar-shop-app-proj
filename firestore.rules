/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for appointments
 * and user profiles, while allowing public read access for general data like services
 * and barbers.
 *
 * Data Structure:
 * - /users/{userId}: Private user profiles.
 * - /appointments/{appointmentId}: Appointments, with access controlled by the `clientId` field.
 * - /services/{serviceId}: Publicly readable services.
 * - /barbers/{barberId}: Publicly readable barbers.
 *
 * Key Security Decisions:
 * - User Enumeration is Disallowed: The top-level `/users` collection cannot be listed.
 * - Strict Ownership for Sensitive Data: A user can only access their own profile and appointments.
 * - Public Data is Read-Only for Clients: Services and barbers can be read by anyone but cannot be
 *   modified by client applications.
 * - No Admin Roles in Rules: Administrative functions must be handled by a trusted backend.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Access is strictly limited to the document owner.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isOwner(userId);
      // Deny listing all users.
      allow list: if false;
    }

    /**
     * @description Manages services. Publicly readable, but not writable from the client.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages barbers. Publicly readable, but not writable from the client.
     */
    match /barbers/{barberId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
    
    /**
     * @description Manages appointment documents.
     */
    match /appointments/{appointmentId} {
        allow get, list: if isSignedIn() && request.query.where[0][2] == request.auth.uid;
        allow create: if isSignedIn() && request.resource.data.clientId == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.clientId == request.auth.uid;
    }
  }
}
